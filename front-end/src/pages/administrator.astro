---
import AdminSubscriptions from "../components/administrator/formulario";
import MainLayout from "../layout/MainLayout.astro";
import { getSession } from "auth-astro/server";
import type { Plan } from "../types/plan/plan";
import type { Subscription } from "../types/subscription/subscription";
import type { User } from "../types/user/user";

// Obtener la sesi칩n del usuario
const session = await getSession(Astro.request);

// Verificar si la sesi칩n est치 iniciada
if (!session) {
  return Astro.redirect("/sign-in");
}

// ===========================================================================
// Obtener si el usuario tiene una suscripci칩n activa
// ===========================================================================
const resposePayment = await fetch(
  `${import.meta.env.PUBLIC_BASE_URL_API}/payment?providerId=${session.user?.providerId}`,
);

if (resposePayment.ok) {
  const data = await resposePayment.json();
  session.user!.subscription = data;
}

// ===========================================================================
// Obtener la lista de suscripciones
// ===========================================================================

// curl -X 'GET' \
//   'http://localhost:8080/payment/all' \
//   -H 'accept: */*'

const responseSubscriptions = await fetch(
  `${import.meta.env.PUBLIC_BASE_URL_API}/payment/all`,
);

let subscriptions: Subscription[] = [];

if (responseSubscriptions.ok) {
  const data = await responseSubscriptions.json();
  subscriptions = data;
}

// ===========================================================================
// Obtener los planes disponibles
// ===========================================================================
const responsePlan = await fetch(`${import.meta.env.PUBLIC_BASE_URL_API}/plan`);

let plans: Plan[] = [];

if (responsePlan.ok) {
    const data = await responsePlan.json();
    plans = data;
}

// ===========================================================================
// Obtener lista de usuarios
// ===========================================================================
const responseUsers = await fetch(`${import.meta.env.PUBLIC_BASE_URL_API}/user`);

let users: User[] = [];

if (responseUsers.ok) {
    const data = await responseUsers.json();
    users = data;
}
// ===========================================================================
---

<MainLayout title="Open Book">
  <AdminSubscriptions client:load 
  session={session}
   subscriptions={subscriptions}
   plans={plans}
   users={users} 
   coupons={[]}
   />
</MainLayout>
