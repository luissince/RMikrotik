---
import FormularioAccount from "../components/account/formulario";
import MainLayout from "../layout/MainLayout.astro";
import { getSession } from "auth-astro/server";

const session = await getSession(Astro.request);

if (!session) {
  return Astro.redirect("/sign-in");
}

const response = await fetch(
  `${import.meta.env.PUBLIC_BASE_URL_API}/payment?providerId=${session.user?.providerId}`,
);

if (response.ok) {
  const data = await response.json();
  session.user!.subscription = data;
}
---

<MainLayout title="Open Book">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-gray-800 shadow-lg p-6 rounded-lg text-center mb-8">
      <h1 class="text-2xl lg:text-4xl font-bold text-blue-400">
        <span class="text-white"><strong>MI CUENTA</strong></span>
      </h1>
      <p class="text-gray-500 mt-2 font-bold">
        {session.user!.name}
        <span class="text-sm text-green-600 font-bold">
          | Membresía de la cuenta {
            session.user!.subscription?.status || "sin suscripción"
          } |</span
        >
      </p>
    </div>

    <!-- Modal para métodos de pago -->
    <FormularioAccount client:load session={session} />
  </div>
</MainLayout>
